<html>
    <head>
        <link rel="stylesheet" href="./static/style.css">
    </head>
    <body>
        <nav class="navbar">
            <img class="logo" src="./static/images/logo.png">
            <h1 class="title">
                Execution
            </h1>
            
            <a href="index.html" class="home-btn">Home</a>
        </nav>
        <br>
        <div class="execution-btns">
            <button class="btn btn-success" onclick="openForm()">Configuration</button>
            <button class="btn btn-warning" onclick="openRunForm()">Runtime</button>
        </div>

        <div class="form-popup" id="myForm">
            <form class="form-container">
                <div>
                    <h2>Configuration</h2>   
                    <div class="grid" id="configuration-div"></div>
        
                    <span onclick="selects()">Select all</span>
                    <span onclick="deSelect()">Deselect all</span>
                </div>
                <div class="action">
                    <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
                    <button type="button" class="btn" onclick="submitConfigurationChange()">Submit</button>
                </div>
                <table>
                    <tr>
                        <th>Test case id</th>
                        <th>Module</th>
                        <th>Test Title</th>
                        <th>Run By</th>
                    </tr>
                    <tbody id="config-table">

                    </tbody>
                </table>
              </form>
        </div>

        <div class="form-Runtimepopup" id="Runtime">
            <form class="form-container">
                <div>
                    <h2>Runtime</h2>   
                    <div class="grid" id="runtime-div"></div>
        
                    <span onclick="selects()">Select all</span>
                    <span onclick="deSelect()">Deselect all</span>
                </div>
                <div class="action">
                    <button type="button" class="btn cancel" onclick="closeRunForm()">Close</button>
                    <button type="button" class="btn" onclick="submitRuntimeChange()">Submit</button>
                </div>
                <table>
                    <tr>
                        <th>Test case id</th>
                        <th>Module</th>
                        <th>Test Title</th>
                        <th>Run By</th>
                    </tr>
                    <tbody id="runtime-table">

                    </tbody>
                </table>
              </form>
        </div>

        <script>
            function selects(){  
                var ele=document.getElementsByName('check');  
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox')  
                        ele[i].checked=true;  
                }  
            }

            function deSelect(){  
                var ele=document.getElementsByName('check');  
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox')  
                        ele[i].checked=false;  
                      
                }  
            }

            let configurations = [];
            const submitConfigurationChange = () => {
                console.log('config changes ', configurations);
                fetch('/getFilesContent', {
                    method: "POST",
                    body: JSON.stringify({
                        data: configurations
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => res.json()).then(data => {
                    console.log('data is ', data);
                    const configTable = document.getElementById('config-table');
                    configTable.innerHTML = ''; // Clear previous table content
                    for (const d of data) {
                        const row = document.createElement('tr');
                        const keys = Object.keys(d);
                        keys.forEach(key => {
                            const val = d[key];
                            const td = document.createElement('td');
                            td.appendChild(document.createTextNode(val));
                            row.appendChild(td);
                        });
                        configTable.appendChild(row);
                    }
                }).catch(err => {
                    console.log('error is ', err);
                    alert('config file not found or error in fetching from server');
                });
            }

            let runtime = [];
            const submitRuntimeChange = () => {
                console.log('runtime changes ', runtime);
                fetch('/getRuntimeFilesContent', {
                    method: "POST",
                    body: JSON.stringify({
                        data: runtime
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => res.json()).then(data => {
                    console.log('data is ', data);
                    const runtimeTable = document.getElementById('runtime-table');
                    runtimeTable.innerHTML = ''; // Clear previous table content
                    for (const d of data) {
                        const row = document.createElement('tr');
                        const keys = Object.keys(d);
                        keys.forEach(key => {
                            const val = d[key];
                            const td = document.createElement('td');
                            td.appendChild(document.createTextNode(val));
                            row.appendChild(td);
                        });
                        runtimeTable.appendChild(row);
                    }
                }).catch(err => {
                    console.log('error is ', err);
                    alert('runtime not found or error in fetching from server');
                });
            }

            window.onload = function() {
                const handleConfigurationChange = (e) => {
                    console.log('config change triggered');
                    console.log('id is ', e.target.id);
                    if (!configurations.includes(e.target.id)) {
                        configurations.push(e.target.id);
                    } else {
                        configurations = configurations.filter(item => item != e.target.id);
                    }
                    console.log(configurations);
                }

                const handleRuntimeChange = (e) => {
                    console.log('runtime change triggered');
                    console.log('id is ', e.target.id);
                    if (!runtime.includes(e.target.id)) {
                        runtime.push(e.target.id);
                    } else {
                        runtime = runtime.filter(item => item != e.target.id);
                    }
                    console.log(runtime);
                }

              fetch('/getConfiguration')
                .then(res => res.json())
                .then(data => {
                    const configurationDiv = document.getElementById("configuration-div");

                    if (data) {
                        for (const d of data) {
                            if (d === "") {
                                continue;
                            }

                            const labelDiv = document.createElement('label');
                            const inputElement = document.createElement('input');

                            const linkElement = document.createElement('a');
                            linkElement.href = 'your-link-here'; // Replace with your desired link

                            labelDiv.innerText = d;
                            labelDiv.onclick = () => {
                                if (!isPopupOpen) {
                                    inputElement.checked = true;
                                }
                                openPopup();
                            };
                            labelDiv.style.cursor = 'pointer'; // Add pointer cursor style to indicate clickable label

                            inputElement.type = 'checkbox';
                            inputElement.style.cssText = 'width: 20px; height: 20px; margin-left: 15px;';
                            inputElement.value = d;
                            inputElement.setAttribute('name', 'check');
                            inputElement.setAttribute('id', d);
                            inputElement.onclick = (e) => {
                            e.stopPropagation(); // Prevent label click event from triggering when clicking the checkbox
                        };

                        inputElement.onchange = (e) => {
                            if (!isPopupOpen) {
                                window.location.href = linkElement.href;
                            }
                        };

                        labelDiv.appendChild(inputElement);
                        labelDiv.appendChild(linkElement);
                        configurationDiv.appendChild(labelDiv);
                    }
                }
            });

                let isPopupOpen = false;

                function openPopup() {
                    isPopupOpen = true;
                    // Code to show the popup
                    alert("Popup")
                }

                fetch('/getRuntime').then(res => res.json()).then(data => {
                    const runtimeDiv = document.getElementById("runtime-div");
                    if (data) {
                        for (const d of data) {
                            if (d == "") {
                                continue;
                            }
                            const labelDiv = document.createElement('label');
                            const inputElement = document.createElement('input');
                            labelDiv.innerText = d;
                            inputElement.type = 'checkbox';
                            inputElement.setAttribute('name', 'check');
                            inputElement.value = d;
                            inputElement.style.cssText = 'width: 20px; height: 20px; margin-left: 15px;';
                            inputElement.onchange = (e) => {
                                handleRuntimeChange(e);
                            }

                            labelDiv.appendChild(inputElement);
                            runtimeDiv.appendChild(labelDiv);
                        }
                    }
                });
            }

            
        </script>
        <script>    
            function openForm() {
              document.getElementById("myForm").style.display = "block";
            }
                       
            function closeForm() {
              document.getElementById("myForm").style.display = "none";
            }

            function openRunForm() {
              document.getElementById("Runtime").style.display = "block";
            }

            function closeRunForm() {
              document.getElementById("Runtime").style.display = "none";
            }
        </script>
    </body>
</html>
